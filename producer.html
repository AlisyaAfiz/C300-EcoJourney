<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoJourney CMS - My Content</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="frontend/static/css/style.css">
    <style>
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="frontend/static/logo.png" alt="EcoJourney Logo" class="sidebar-logo">
                    <h3>EcoJourney</h3>
                </div>
                <p>Content Management System</p>
            </div>

            <div class="nav" id="sidebar-nav">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
                <a href="producer.html" class="nav-link active" id="nav-content">
                    <i class="fas fa-file-upload"></i> My Content
                </a>
                <a href="notifications.html" class="nav-link">
                    <i class="fas fa-bell"></i> Notifications
                </a>
                <a href="manager.html" class="nav-link" id="nav-approvals" style="display: none;">
                    <i class="fas fa-check-circle"></i> Approvals
                </a>
                <a href="admin.html" class="nav-link" id="nav-admin" style="display: none;">
                    <i class="fas fa-cog"></i> Administration
                </a>
                <a href="profile.html" class="nav-link">
                    <i class="fas fa-user"></i> Profile
                </a>
            </div>

            <div class="sidebar-footer">
                <a class="nav-link" href="#" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="content">
            <!-- Top Navigation Bar -->
            <nav class="topbar">
                <div class="topbar-left">
                    <h4>My Content</h4>
                </div>

                <div class="topbar-right">
                    <div class="user-info">
                        <div class="user-avatar">P</div>
                        <div class="user-details">
                            <h6>User Name</h6>
                            <small class="profile-role">Producer</small>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content Area -->
            <div class="main-content">
                <!-- Content List View -->
                <div id="content-list-view">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h1 class="page-title" style="margin: 0;">My Content</h1>
                        <button class="btn btn-primary" onclick="showUploadForm()">
                            <i class="fas fa-upload"></i> Upload Content
                        </button>
                    </div>

                    <!-- Filters -->
                    <div class="card mb-3" id="content-filters">
                        <div class="card-body p-3">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text bg-white"><i class="fas fa-search"></i></span>
                                        <input type="text" class="form-control border-start-0" id="filter-search" placeholder="Search by title...">
                                    </div>
                                </div>
                                
                                <div class="col-md-2">
                                    <select class="form-select" id="filter-category">
                                        <option value="all">All Categories</option>
                                        <option value="Environmental">Environmental</option>
                                        <option value="Social">Social</option>
                                        <option value="Governance">Governance</option>
                                    </select>
                                </div>

                                <div class="col-md-2">
                                    <select class="form-select" id="filter-status">
                                        <option value="all">All Statuses</option>
                                        <option value="Approved">Approved</option>
                                        <option value="Pending">Pending</option>
                                        <option value="Rejected">Rejected</option>
                                    </select>
                                </div>

                                <div class="col-md-4">
                                    <div class="input-group">
                                        <span class="input-group-text">Sort By:</span>
                                        <select class="form-select" id="sort-order">
                                            <option value="newest">Newest Modified</option>
                                            <option value="oldest">Oldest Modified</option>
                                            <option value="az">A-Z (Title)</option>
                                            <option value="za">Z-A (Title)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Content List -->
                    <div class="card">
                        <div class="card-header card-header-modern">
                            <h5><i class="fas fa-folder-open"></i> Your Content</h5>
                        </div>
                        <div class="card-body p-0">
                            <!-- Column Headers -->
                            <div class="content-list-header">
                                <div class="header-left">Content Details</div>
                                <div class="header-right">
                                    <span class="header-col">Status</span>
                                    <span class="header-col">Actions</span>
                                </div>
                            </div>
                            <!-- Content Items -->
                            <div id="content-items-container">
                                <div class="text-center p-5 text-muted">
                                    <i class="fas fa-spinner fa-spin fa-3x mb-3"></i>
                                    <p>Loading content...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Form -->
                <div id="upload-form-section" style="display: none;">
                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-upload"></i> Upload New Content</h5>
                        </div>
                        <div class="card-body">
                            <form id="upload-form">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Title</label>
                                    <input type="text" class="form-control" id="content-title" required placeholder="Enter content title">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Description</label>
                                    <textarea class="form-control" id="content-description" rows="4" required placeholder="Enter content description"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Category</label>
                                    <select class="form-control" id="content-category" required>
                                        <option value="">Select a category</option>
                                        <option value="Environmental">Environmental</option>
                                        <option value="Social">Social</option>
                                        <option value="Governance">Governance</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Media File (Image/Video)</label>
                                    <input type="file" class="form-control" id="content-media" accept="image/*,video/*" required>
                                    <small class="text-muted d-block mt-1">Upload an image or video to display for this project</small>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Project Document</label>
                                    <input type="file" class="form-control" id="content-file" required>
                                    <small class="text-muted d-block mt-1">Upload project details (PDF, DOC, DOCX, etc. - Max 500MB)</small>
                                </div>

                                <div class="d-flex gap-2 mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-upload"></i> Upload Content
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="hideUploadForm()">
                                        <i class="fas fa-arrow-left"></i> Back
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Content Detail View -->
                <div id="content-detail-view" style="display: none;">
                    <button class="btn btn-primary" onclick="backToContentList()" style="margin-bottom: 20px; background: #7f8c8d;">
                        <i class="fas fa-arrow-left"></i> Back to My Content
                    </button>

                    <div class="detail-header">
                        <h2 id="detail-title">Content Title</h2>
                        <div class="detail-meta-row">
                            <div class="detail-meta-item">
                                <i class="fas fa-file"></i>
                                <span id="detail-type">Document</span>
                            </div>
                            <div class="detail-meta-item">
                                <i class="fas fa-hdd"></i>
                                <span id="detail-size">0 KB</span>
                            </div>
                            <div class="detail-meta-item">
                                <i class="fas fa-calendar"></i>
                                <span id="detail-date">-</span>
                            </div>
                            <div class="detail-meta-item">
                                <i class="fas fa-tag"></i>
                                <span id="detail-category">-</span>
                            </div>
                            <div class="detail-meta-item">
                                <i class="fas fa-info-circle"></i>
                                <span id="detail-status">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- Media Preview Section -->
                    <div id="detail-media-preview" class="detail-section" style="display: none;">
                        <h4><i class="fas fa-image"></i> Media Preview</h4>
                        <div style="text-align: center; padding: 20px;">
                            <img id="detail-image-preview" style="max-width: 100%; max-height: 500px; border-radius: 8px; display: none; margin: 0 auto;" />
                            <video id="detail-video-preview" controls style="max-width: 100%; max-height: 500px; border-radius: 8px; display: none; margin: 0 auto;"></video>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h4><i class="fas fa-align-left"></i> Description</h4>
                        <p id="detail-description">No description available.</p>
                    </div>

                    <div class="detail-section">
                        <h4><i class="fas fa-info-circle"></i> File Information</h4>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <strong>Content ID:</strong>
                                <p id="detail-id" style="margin: 5px 0;">-</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>File Format:</strong>
                                <p id="detail-format" style="margin: 5px 0;">-</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Upload Date:</strong>
                                <p id="detail-upload-date" style="margin: 5px 0;">-</p>
                            </div>
                            <div class="col-md-6 mb-3">
                                <strong>Status:</strong>
                                <p id="detail-status-info" style="margin: 5px 0;">-</p>
                            </div>
                        </div>
                    </div>

                    <div class="detail-actions">
                        <button class="btn btn-primary" onclick="downloadCurrentContent()">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button class="btn btn-primary" style="background: #9b59b6;" onclick="previewContent()">
                            <i class="fas fa-eye"></i> Preview Link
                        </button>
                        <button class="btn btn-primary" style="background: #3498db;" onclick="editCurrentContent()">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-primary" style="background: #e74c3c;" onclick="deleteCurrentContent()">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>

                <!-- Content Edit Form -->
                <div id="content-edit-form" style="display: none;">
                    <button class="btn btn-primary" onclick="cancelEdit()" style="margin-bottom: 20px; background: #7f8c8d;">
                        <i class="fas fa-arrow-left"></i> Cancel
                    </button>

                    <div class="card">
                        <div class="card-header">
                            <h5><i class="fas fa-edit"></i> Edit Content</h5>
                        </div>
                        <div class="card-body">
                            <form id="edit-content-form">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Title</label>
                                    <input type="text" class="form-control" id="edit-title" required placeholder="Enter content title">
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Description</label>
                                    <textarea class="form-control" id="edit-description" rows="6" required placeholder="Enter content description"></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Category</label>
                                    <select class="form-control" id="edit-category" required>
                                        <option value="">Select a category</option>
                                        <option value="Environmental">Environmental</option>
                                        <option value="Social">Social</option>
                                        <option value="Governance">Governance</option>
                                    </select>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Replace Media File (Optional)</label>
                                    <input type="file" class="form-control" id="edit-media" accept="image/*,video/*">
                                    <small class="text-muted d-block mt-1">Leave empty to keep current media. Upload new image/video to replace it.</small>
                                    <div id="edit-current-media" style="margin-top: 15px; text-align: center; display: none;">
                                        <strong style="display: block; margin-bottom: 10px;">Current Media:</strong>
                                        <img id="edit-current-image" style="max-width: 100%; max-height: 300px; border-radius: 8px; display: none; margin: 0 auto;" />
                                        <video id="edit-current-video" controls style="max-width: 100%; max-height: 300px; border-radius: 8px; display: none; margin: 0 auto;"></video>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-bold">Replace Project Document (Optional)</label>
                                    <input type="file" class="form-control" id="edit-file">
                                    <small class="text-muted d-block mt-1">Leave empty to keep current document. Upload new file to replace it.</small>
                                    <div id="current-file-info" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: none;">
                                        <strong>Current document:</strong> <span id="current-file-display"></span>
                                    </div>
                                </div>

                                <div class="d-flex gap-2 mt-4">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button type="button" class="btn btn-secondary" onclick="cancelEdit()">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Success Popup -->
    <div id="successPopup" class="success-popup-overlay">
        <div class="success-popup">
            <div class="success-popup-icon">
                <i class="fas fa-check"></i>
            </div>
            <h3>Success!</h3>
            <p id="successPopupMessage">Content uploaded successfully!</p>
            <button class="success-popup-btn" onclick="EcoJourney.closeSuccessPopup()">Great!</button>
        </div>
    </div>

    <!-- Confirmation Popup -->
    <div id="confirmPopup" class="confirm-popup-overlay">
        <div class="confirm-popup">
            <div class="confirm-popup-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3>Delete Content?</h3>
            <p>Are you sure you want to delete this content? This action cannot be undone.</p>
            <div class="confirm-popup-buttons">
                <button class="confirm-popup-btn yes" onclick="confirmDelete(true)">Yes, Delete</button>
                <button class="confirm-popup-btn no" onclick="confirmDelete(false)">Cancel</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="frontend/static/js/common.js"></script>
    <script>
        // Producer page specific JavaScript
        // Use API_URL from common.js
        let allContent = [];
        
        // Helper functions
        function formatFileSize(bytes) {
            if (!bytes || bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }
        
        function formatToSGTime(isoString) {
            if (!isoString || isoString === 'undefined') return '-';
            const date = new Date(isoString);
            if (isNaN(date.getTime())) return '-';
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
        
        async function loadContent() {
            console.log('[Producer] Loading content from API...');
            
            // Show loading state
            document.getElementById('content-items-container').innerHTML = `
                <div class="text-center p-5" style="min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div style="font-size: 60px; color: #2ecc71; margin-bottom: 15px; animation: spin 2s linear infinite;">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <p style="font-size: 16px; color: #2c3e50; margin-bottom: 5px; font-weight: 600;">Loading content...</p>
                    <p style="font-size: 13px; color: #7f8c8d;">Please wait while we fetch your content</p>
                </div>
            `;
            
            try {
                const response = await fetch(`${API_URL}/api/content/all`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('auth_token') || '')
                    }
                });

                if (!response.ok) {
                    console.error('[Producer] API error:', response.status);
                    document.getElementById('content-items-container').innerHTML = `
                        <div class="text-center p-5" style="min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <div style="font-size: 60px; color: #e74c3c; margin-bottom: 15px;">
                                <i class="fas fa-exclamation-circle"></i>
                            </div>
                            <p style="font-size: 16px; color: #2c3e50; margin-bottom: 5px; font-weight: 600;">Failed to load content</p>
                            <p style="font-size: 13px; color: #7f8c8d; margin-bottom: 15px;">Error ${response.status}</p>
                            <button class="btn btn-primary" onclick="location.reload()" style="background: #2ecc71; border: none;">
                                <i class="fas fa-sync"></i> Retry
                            </button>
                        </div>
                    `;
                    return;
                }

                allContent = await response.json();
                console.log('[Producer] âœ“ Loaded', allContent.length, 'items');
                filterAndRenderContent();
                
            } catch (error) {
                console.error('[Producer] Load error:', error);
                document.getElementById('content-items-container').innerHTML = `
                    <div class="text-center p-5" style="min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <div style="font-size: 60px; color: #e74c3c; margin-bottom: 15px;">
                            <i class="fas fa-exclamation-circle"></i>
                        </div>
                        <p style="font-size: 16px; color: #2c3e50; margin-bottom: 5px; font-weight: 600;">Error loading content</p>
                        <p style="font-size: 13px; color: #7f8c8d; margin-bottom: 15px;">${error.message}</p>
                        <button class="btn btn-primary" onclick="location.reload()" style="background: #2ecc71; border: none;">
                            <i class="fas fa-sync"></i> Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function filterAndRenderContent() {
            console.log('[Producer] Filtering content...');
            
            const searchTerm = document.getElementById('filter-search')?.value.toLowerCase() || '';
            const categoryFilter = document.getElementById('filter-category')?.value || 'all';
            const statusFilter = document.getElementById('filter-status')?.value || 'all';
            const sortOrder = document.getElementById('sort-order')?.value || 'newest';
            
            // Filter
            let filtered = allContent.filter(item => {
                const matchesSearch = item.title.toLowerCase().includes(searchTerm);
                const matchesCategory = categoryFilter === 'all' || item.category === categoryFilter;
                const matchesStatus = statusFilter === 'all' || (item.status || 'Pending').toLowerCase() === statusFilter.toLowerCase();
                return matchesSearch && matchesCategory && matchesStatus;
            });
            
            // Sort
            filtered.sort((a, b) => {
                const dateA = new Date(a.updatedAt || a.date);
                const dateB = new Date(b.updatedAt || b.date);
                const titleA = a.title.toLowerCase();
                const titleB = b.title.toLowerCase();
                
                switch (sortOrder) {
                    case 'newest': return dateB - dateA;
                    case 'oldest': return dateA - dateB;
                    case 'az': return titleA.localeCompare(titleB);
                    case 'za': return titleB.localeCompare(titleA);
                    default: return dateB - dateA;
                }
            });
            
            console.log('[Producer] Rendering', filtered.length, 'items');
            renderContentList(filtered);
        }
        
        function renderContentList(items) {
            const container = document.getElementById('content-items-container');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (items.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-5" style="min-height: 300px; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <div style="font-size: 60px; color: #bdc3c7; margin-bottom: 15px;">
                            <i class="fas fa-folder-open"></i>
                        </div>
                        <p style="font-size: 16px; color: #2c3e50; margin-bottom: 5px; font-weight: 600;">No content found</p>
                        <p style="font-size: 13px; color: #7f8c8d;">No content matches your filters. Try uploading new content or adjusting your search.</p>
                    </div>
                `;
                return;
            }
            
            items.forEach(content => {
                const statusClass = (content.status || 'Pending').toLowerCase().includes('approved') ? 'badge-success' :
                                    (content.status || 'Pending').toLowerCase().includes('rejected') ? 'badge-danger' :
                                    'badge-warning';
                
                const row = document.createElement('div');
                row.className = 'content-item content-item-clickable';
                row.setAttribute('data-id', content._id || content.id);
                row.setAttribute('data-title', content.title);
                row.setAttribute('data-type', content.type || 'Document');
                row.setAttribute('data-size', content.fileSize);
                row.setAttribute('data-date', content.updatedAt || content.date);
                row.setAttribute('data-status', content.status || 'Pending');
                row.setAttribute('data-category', content.category || 'General');
                row.setAttribute('data-description', content.description || '');
                row.onclick = () => viewContentDetail(row);
                
                row.innerHTML = `
                    <div>
                        <div class="content-title">${content.title}</div>
                        <div class="content-meta">
                            ${content.type || 'Document'} | ${formatFileSize(content.fileSize)} | Modified: ${formatToSGTime(content.updatedAt || content.date)}
                        </div>
                    </div>
                    <div class="content-item-actions">
                        <span class="badge ${statusClass}">${content.status || 'Pending'}</span>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteContent('${content._id || content.id}')" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                container.appendChild(row);
            });
        }
        
        function showUploadForm() {
            document.getElementById('content-list-view').style.display = 'none';
            document.getElementById('upload-form-section').style.display = 'block';
        }
        
        function hideUploadForm() {
            document.getElementById('content-list-view').style.display = 'block';
            document.getElementById('upload-form-section').style.display = 'none';
            document.getElementById('upload-form').reset();
        }
        
        // Use currentViewingContentId and pendingDeleteId from common.js
        
        function deleteContent(id) {
            pendingDeleteId = id;
            document.getElementById('confirmPopup').classList.add('show');
        }
        
        function closeConfirmPopup() {
            pendingDeleteId = null;
            document.getElementById('confirmPopup').classList.remove('show');
        }
        
        async function confirmDelete(confirmed) {
            if (!confirmed || !pendingDeleteId) {
                closeConfirmPopup();
                return;
            }
            
            try {
                const response = await fetch(`${API_URL}/api/content/${pendingDeleteId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + (localStorage.getItem('auth_token') || '')
                    }
                });
                
                if (!response.ok) throw new Error('Delete failed');
                
                closeConfirmPopup();
                EcoJourney.showSuccessPopup('Content deleted successfully!');
                // Return to list after 2 seconds
                setTimeout(() => {
                    loadContent();
                    backToContentList();
                }, 2000);
            } catch (error) {
                alert('Failed to delete: ' + error.message);
            }
        }

        async function viewContentDetail(element) {
            const contentData = {
                id: element.dataset.id,
                title: element.dataset.title,
                type: element.dataset.type,
                size: element.dataset.size,
                date: element.dataset.date,
                status: element.dataset.status,
                category: element.dataset.category,
                description: element.dataset.description
            };

            currentViewingContentId = contentData.id;

            // Hide list and upload form, show detail view
            document.getElementById('content-list-view').style.display = 'none';
            document.getElementById('upload-form-section').style.display = 'none';
            document.getElementById('content-detail-view').style.display = 'block';
            document.getElementById('content-edit-form').style.display = 'none';

            // Populate detail view
            document.getElementById('detail-title').textContent = contentData.title;
            document.getElementById('detail-type').textContent = contentData.type;
            document.getElementById('detail-size').textContent = EcoJourney.formatFileSize(contentData.size);
            document.getElementById('detail-date').textContent = EcoJourney.formatToSGTime(contentData.date);
            document.getElementById('detail-category').textContent = contentData.category;
            document.getElementById('detail-status').textContent = contentData.status;
            document.getElementById('detail-description').textContent = contentData.description || 'No description available.';
            document.getElementById('detail-id').textContent = EcoJourney.formatContentId(contentData.id);
            document.getElementById('detail-format').textContent = contentData.type;
            document.getElementById('detail-upload-date').textContent = EcoJourney.formatDateTime(contentData.date);
            document.getElementById('detail-status-info').textContent = contentData.status;

            // Try to load media preview
            const mediaPreview = document.getElementById('detail-media-preview');
            const imagePreview = document.getElementById('detail-image-preview');
            const videoPreview = document.getElementById('detail-video-preview');

            imagePreview.style.display = 'none';
            videoPreview.style.display = 'none';
            mediaPreview.style.display = 'none';

            try {
                const response = await fetch(`${EcoJourney.API_URL}/api/content/${contentData.id}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.mediaData) {
                        if (data.mediaFileType?.startsWith('image/')) {
                            imagePreview.src = data.mediaData;
                            imagePreview.style.display = 'block';
                            mediaPreview.style.display = 'block';
                        } else if (data.mediaFileType?.startsWith('video/')) {
                            videoPreview.src = data.mediaData;
                            videoPreview.style.display = 'block';
                            mediaPreview.style.display = 'block';
                        }
                    }
                }
            } catch (e) {
                console.error('Preview failed', e);
            }
        }

        function backToContentList() {
            document.getElementById('content-list-view').style.display = 'block';
            document.getElementById('upload-form-section').style.display = 'none';
            document.getElementById('content-detail-view').style.display = 'none';
            document.getElementById('content-edit-form').style.display = 'none';
            currentViewingContentId = null;
        }

        function editCurrentContent() {
            if (!currentViewingContentId) return;

            // Hide detail view, show edit form
            document.getElementById('content-detail-view').style.display = 'none';
            document.getElementById('content-edit-form').style.display = 'block';

            // Get current content
            const content = allContent.find(c => (c._id || c.id) === currentViewingContentId);
            if (!content) return;

            // Pre-fill the form
            document.getElementById('edit-title').value = content.title;
            document.getElementById('edit-description').value = content.description || '';
            document.getElementById('edit-category').value = content.category || '';
            document.getElementById('edit-file').value = '';
            document.getElementById('edit-media').value = '';

            // Show current file info
            const currentFileInfo = document.getElementById('current-file-info');
            const currentFileDisplay = document.getElementById('current-file-display');
            currentFileDisplay.textContent = `${content.type || 'Document'} (${EcoJourney.formatFileSize(content.fileSize)})`;
            currentFileInfo.style.display = 'block';
        }

        function cancelEdit() {
            document.getElementById('content-edit-form').style.display = 'none';
            document.getElementById('content-detail-view').style.display = 'block';
        }

        function deleteCurrentContent() {
            if (currentViewingContentId) {
                EcoJourney.showConfirmPopup(currentViewingContentId);
            }
        }

        async function downloadCurrentContent() {
            if (!currentViewingContentId) return;
            try {
                const downloadUrl = `${EcoJourney.API_URL}/api/download/${currentViewingContentId}`;
                window.open(downloadUrl, '_blank');
                EcoJourney.showSuccessPopup('Download started!');
            } catch (error) {
                console.error('Download failed:', error);
                alert('Download failed: ' + error.message);
            }
        }

        function previewContent() {
            if (!currentViewingContentId) return;
            window.open(`content-detail.html?id=${currentViewingContentId}`, '_blank');
        }
        
        // Initialize on page load
        window.addEventListener('DOMContentLoaded', async () => {
            console.log('[Producer] Page loaded');
            
            // Update user info and sidebar
            if (typeof EcoJourney !== 'undefined') {
                EcoJourney.updateUserInfo();
                EcoJourney.renderSidebar('content');
                
                // Attach logout handler
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        EcoJourney.logout();
                    });
                }
            }
            
            // Load content
            await loadContent();
            
            // Attach filter listeners
            document.getElementById('filter-search')?.addEventListener('input', filterAndRenderContent);
            document.getElementById('filter-category')?.addEventListener('change', filterAndRenderContent);
            document.getElementById('filter-status')?.addEventListener('change', filterAndRenderContent);
            document.getElementById('sort-order')?.addEventListener('change', filterAndRenderContent);
            
            // Upload form handler
            document.getElementById('upload-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const title = document.getElementById('content-title').value;
                const description = document.getElementById('content-description').value;
                const category = document.getElementById('content-category').value;
                const mediaFile = document.getElementById('content-media').files[0];
                const docFile = document.getElementById('content-file').files[0];
                
                if (!title || !category || !mediaFile || !docFile) {
                    alert('Please fill in all required fields');
                    return;
                }
                
                // Check file sizes
                const maxSize = 500 * 1024 * 1024; // 500MB
                if (mediaFile.size > maxSize || docFile.size > maxSize) {
                    alert('File size exceeds 500MB limit');
                    return;
                }
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
                submitBtn.disabled = true;
                
                try {
                    const formData = new FormData();
                    formData.append('title', title);
                    formData.append('description', description);
                    formData.append('category', category);
                    formData.append('mediaFile', mediaFile);
                    formData.append('documentFile', docFile);
                    
                    const docName = docFile.name.toLowerCase();
                    const docType = docName.endsWith('.pdf') ? 'PDF' : 'Document';
                    formData.append('type', docType);
                    
                    const response = await fetch(`${EcoJourney.API_URL}/api/content/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem(EcoJourney.STORAGE_KEY)
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Upload failed');
                    }
                    
                    EcoJourney.showSuccessPopup('Content uploaded successfully!');
                    hideUploadForm();
                    // Auto refresh after 1 second
                    setTimeout(() => {
                        loadContent();
                        backToContentList(); // Go back to list view
                    }, 1000);
                    
                } catch (error) {
                    console.error('Upload failed:', error);
                    alert('Upload failed: ' + error.message);
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });
            
            // Edit form handler
            document.getElementById('edit-content-form')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!currentViewingContentId) {
                    alert('No content selected');
                    return;
                }
                
                const title = document.getElementById('edit-title').value;
                const description = document.getElementById('edit-description').value;
                const category = document.getElementById('edit-category').value;
                
                if (!title || !category) {
                    alert('Please fill in title and category');
                    return;
                }
                
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                submitBtn.disabled = true;
                
                try {
                    const formData = new FormData();
                    formData.append('title', title);
                    formData.append('description', description);
                    formData.append('category', category);
                    
                    const newMediaFile = document.getElementById('edit-media').files[0];
                    const newDocFile = document.getElementById('edit-file').files[0];
                    
                    if (newMediaFile) formData.append('mediaFile', newMediaFile);
                    if (newDocFile) {
                        formData.append('documentFile', newDocFile);
                        const docName = newDocFile.name.toLowerCase();
                        const docType = docName.endsWith('.pdf') ? 'PDF' : 'Document';
                        formData.append('type', docType);
                    }
                    
                    const response = await fetch(`${EcoJourney.API_URL}/api/content/${currentViewingContentId}`, {
                        method: 'PUT',
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem(EcoJourney.STORAGE_KEY)
                        },
                        body: formData
                    });
                    
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Update failed');
                    }
                    
                    EcoJourney.showSuccessPopup('Content updated successfully!');
                    // Auto refresh detail view after 1 second
                    setTimeout(async () => {
                        await loadContent(); // Reload all content
                        // Find the updated content and re-display full detail
                        const updatedContent = allContent.find(c => (c._id || c.id) === currentViewingContentId);
                        if (updatedContent) {
                            // Hide edit form, show detail
                            document.getElementById('content-edit-form').style.display = 'none';
                            document.getElementById('content-detail-view').style.display = 'block';
                            
                            // Populate all detail fields with updated data
                            document.getElementById('detail-title').textContent = updatedContent.title;
                            document.getElementById('detail-type').textContent = updatedContent.type;
                            document.getElementById('detail-size').textContent = EcoJourney.formatFileSize(updatedContent.fileSize);
                            document.getElementById('detail-date').textContent = EcoJourney.formatToSGTime(updatedContent.updatedAt || updatedContent.date);
                            document.getElementById('detail-category').textContent = updatedContent.category;
                            document.getElementById('detail-status').textContent = updatedContent.status;
                            document.getElementById('detail-description').textContent = updatedContent.description || 'No description available.';
                            document.getElementById('detail-id').textContent = EcoJourney.formatContentId(updatedContent._id || updatedContent.id);
                            document.getElementById('detail-format').textContent = updatedContent.type;
                            document.getElementById('detail-upload-date').textContent = EcoJourney.formatDateTime(updatedContent.updatedAt || updatedContent.date);
                            document.getElementById('detail-status-info').textContent = updatedContent.status;
                            
                            // Re-fetch media from backend
                            const mediaPreview = document.getElementById('detail-media-preview');
                            const imagePreview = document.getElementById('detail-image-preview');
                            const videoPreview = document.getElementById('detail-video-preview');
                            
                            imagePreview.style.display = 'none';
                            videoPreview.style.display = 'none';
                            mediaPreview.style.display = 'none';
                            
                            try {
                                const response = await fetch(`${EcoJourney.API_URL}/api/content/${currentViewingContentId}`);
                                if (response.ok) {
                                    const data = await response.json();
                                    if (data && data.mediaData) {
                                        if (data.mediaFileType?.startsWith('image/')) {
                                            imagePreview.src = data.mediaData;
                                            imagePreview.style.display = 'block';
                                            mediaPreview.style.display = 'block';
                                        } else if (data.mediaFileType?.startsWith('video/')) {
                                            videoPreview.src = data.mediaData;
                                            videoPreview.style.display = 'block';
                                            mediaPreview.style.display = 'block';
                                        }
                                    }
                                }
                            } catch (e) {
                                console.error('Media refresh failed', e);
                            }
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('Edit failed:', error);
                    alert('Edit failed: ' + error.message);
                } finally {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            });
            
            console.log('[Producer] âœ“ Ready');
        });
    </script>
</body>
</html>
