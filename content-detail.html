<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Preview - EcoJourney</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .hero-section { background: linear-gradient(135deg, #16601d  0%, #16601d 100%); color: white; padding: 60px 0; }
        .media-container { background: #000; border-radius: 15px; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); margin-top: 50px; }
        .media-container img, .media-container video { width: 100%; display: block; max-height: 70vh; object-fit: contain; }
        .description-card { background: white; padding: 40px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-top: 30px; }
        .rp-logo { max-width: 200px; height: auto; margin-bottom: 20px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2)); }
    </style>
</head>
<body>
    <div class="hero-section text-center">
        <div class="container">
            <img src="rp-logo.png" alt="Republic Polytechnic" class="rp-logo">
            
            <h1 id="title" class="display-4 fw-bold">Loading Project...</h1>
            <p id="meta" class="lead opacity-75"></p>
        </div>
    </div>

    <div class="container mb-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="media-container" id="media-box">
                </div>
                
                <div class="description-card">
                    <h3>Project Description</h3>
                    <hr>
                    <p id="description" class="fs-5 text-muted" style="white-space: pre-wrap;"></p>
                    
                    <div class="mt-5 d-flex gap-4">
                        <div><strong>Category:</strong> <span id="category" class="badge bg-success fs-6"></span></div>
                        <div><strong>Last Modified:</strong> <span id="date" class="text-secondary"></span></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')
            ? 'http://localhost:8001'
            : 'https://rpecocjourney-backend.onrender.com';
        
        function formatDate(dateString) {
            if (!dateString || dateString === "Not available" || dateString === "undefined") {
                console.warn('formatDate called with invalid date:', dateString);
                return '-';
            }
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) {
                console.warn('Invalid date format:', dateString);
                return dateString;
            }

            // Format with time
            return date.toLocaleString('en-SG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        async function loadProject() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (!id) return;

            // UPDATED: Always fetch from server first to get latest data
            await fetchFromServer(id);
        }

        async function fetchFromServer(id) {
            try {
                const res = await fetch(`${API_URL}/api/content/${id}`);
                if (res.ok) {
                    const data = await res.json();
                    renderData(data);
                } else {
                    // If server fetch fails, try IndexedDB as fallback
                    tryLocalStorage(id);
                }
            } catch (err) { 
                console.error('Server fetch failed:', err);
                // Fallback to local storage
                tryLocalStorage(id);
            }
        }

        function tryLocalStorage(id) {
            const dbRequest = indexedDB.open('EcoJourneyDB', 1);
            dbRequest.onsuccess = (e) => {
                const db = e.target.result;
                const transaction = db.transaction(['contents'], 'readonly');
                const store = transaction.objectStore('contents');
                const getReq = store.get(id);

                getReq.onsuccess = () => {
                    if (getReq.result) {
                        renderData(getReq.result);
                    } else {
                        document.getElementById('title').textContent = 'Content Not Found';
                        document.getElementById('description').textContent = 'This content may have been deleted.';
                    }
                };
            };
        }

        function renderData(data) {
            document.getElementById('title').textContent = data.title;
            document.getElementById('description').textContent = data.description || "No description provided.";
            document.getElementById('category').textContent = data.category;
            
            // Use updatedAt from MongoDB for modified date
            const displayDate = data.updatedAt || data.createdAt || data.date || null;
            document.getElementById('date').textContent = formatDate(displayDate);
            
            const mediaBox = document.getElementById('media-box');
            const type = data.mediaFileType || "";
            
            if (type.startsWith('image/')) {
                mediaBox.innerHTML = `<img src="${data.mediaData}" alt="Project Image" style="width:100%; height:auto;">`;
            } else if (type.startsWith('video/')) {
                mediaBox.innerHTML = `
                    <video controls autoplay loop muted playsinline style="width:100%;">
                        <source src="${data.mediaData}" type="${type}">
                        Your browser does not support the video tag.
                    </video>`;
            } else {
                mediaBox.innerHTML = `<div class="p-5 text-white text-center"><i class="fas fa-file-alt fa-4x mb-3"></i><p>No preview available.</p></div>`;
            }
        }

        loadProject();
    </script>
</body>
</html>