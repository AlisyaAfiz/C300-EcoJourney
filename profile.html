<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoJourney CMS - Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="frontend/static/css/style.css">
    <style>
        .profile-card {
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .profile-header-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 80px;
        }
        
        .profile-pic-wrapper {
            position: relative;
            width: 120px;
            height: 120px;
            margin: -60px auto 20px;
            cursor: pointer;
        }
        
        .profile-pic {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 4px solid #f8f9fa;
            display: block;
        }
        
        .profile-pic-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        .role-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            margin-bottom: 20px;
            padding: 8px 16px;
            border-radius: 50px;
            display: inline-block;
            font-size: 13px;
        }
        
        .info-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .stat-box {
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
            margin-bottom: 12px;
        }
    </style>
</head>
<body>
    <div class="wrapper">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <img src="frontend/static/logo.png" alt="EcoJourney Logo" class="sidebar-logo">
                    <h3>EcoJourney</h3>
                </div>
                <p>Content Management System</p>
            </div>

            <div class="nav" id="sidebar-nav">
                <a href="index.html" class="nav-link">
                    <i class="fas fa-chart-line"></i> Dashboard
                </a>
                <a href="producer.html" class="nav-link" id="nav-content" style="display: none;">
                    <i class="fas fa-file-upload"></i> My Content
                </a>
                <a href="notifications.html" class="nav-link" id="nav-notifications" style="display: none;">
                    <i class="fas fa-bell"></i> Notifications
                </a>
                <a href="manager.html" class="nav-link" id="nav-approvals" style="display: none;">
                    <i class="fas fa-check-circle"></i> Approvals
                </a>
                <a href="admin.html" class="nav-link" id="nav-admin" style="display: none;">
                    <i class="fas fa-cog"></i> Administration
                </a>
                <a href="profile.html" class="nav-link active">
                    <i class="fas fa-user"></i> Profile
                </a>
            </div>

            <div class="sidebar-footer">
                <a class="nav-link" href="#" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="content">
            <!-- Top Navigation Bar -->
            <nav class="topbar">
                <div class="topbar-left">
                    <h4>My Profile</h4>
                </div>

                <div class="topbar-right">
                    <div class="user-info">
                        <div class="user-avatar">U</div>
                        <div class="user-details">
                            <h6>User Name</h6>
                            <small class="profile-role">Role</small>
                        </div>
                    </div>
                </div>
            </nav>

            <!-- Main Content Area -->
            <div class="main-content">
                <h1 class="page-title mb-4">
                    <i class="fas fa-user-circle"></i> My Profile
                </h1>

                <div class="row">
                    <!-- Profile Card -->
                    <div class="col-md-4 mb-4">
                        <div class="profile-card">
                            <div class="profile-header-bg"></div>
                            <div class="card-body text-center p-4">
                                <!-- Profile Picture -->
                                <div class="profile-pic-wrapper" onclick="document.getElementById('profile-pic-input').click();" title="Click to upload profile picture">
                                    <img id="profile-pic-display" src="https://ui-avatars.com/api/?name=User&background=667eea&color=fff&size=120&bold=true" class="profile-pic">
                                    <div class="profile-pic-overlay">
                                        <i class="fas fa-camera"></i>
                                    </div>
                                </div>
                                <input type="file" id="profile-pic-input" style="display: none;" accept="image/*">
                                <p class="text-muted small mt-2">Click to upload photo</p>

                                <h5 class="fw-bold mb-2" id="profile-name">User Name</h5>
                                <p class="role-badge profile-role">Role</p>

                                <div class="info-box">
                                    <p class="text-uppercase text-muted small mb-1">Email Address</p>
                                    <p class="fw-semibold mb-0" id="profile-email">user@ecojourney.com</p>
                                </div>

                                <div class="border-top pt-3 mt-3">
                                    <p class="text-muted small mb-0">Member Since</p>
                                    <p class="fw-semibold">January 2024</p>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div id="profile-stats" class="mt-3">
                            <!-- Dynamically loaded based on role -->
                        </div>
                    </div>

                    <!-- Edit Profile Form -->
                    <div class="col-md-8">
                        <div class="card">
                            <div class="card-header" style="background: #f8f9fa; color: #2c3e50; border-bottom: 2px solid #ecf0f1;">
                                <h5 class="m-0 fw-bold">
                                    <i class="fas fa-edit"></i> Edit Profile Information
                                </h5>
                            </div>
                            <div class="card-body p-4">
                                <!-- Personal Information -->
                                <h6 class="fw-bold text-dark mb-3 pb-2 border-bottom">
                                    <i class="fas fa-user"></i> Personal Information
                                </h6>

                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-font"></i> First Name
                                        </label>
                                        <input type="text" class="form-control" placeholder="Enter first name">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-font"></i> Last Name
                                        </label>
                                        <input type="text" class="form-control" placeholder="Enter last name">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-building"></i> Organization
                                    </label>
                                    <input type="text" class="form-control" placeholder="Enter organization name">
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-semibold">
                                        <i class="fas fa-phone"></i> Phone Number
                                    </label>
                                    <input type="tel" class="form-control" placeholder="Enter phone number">
                                </div>

                                <!-- Change Password Section -->
                                <div class="bg-light p-4 rounded mt-4">
                                    <h6 class="fw-bold text-dark mb-3">
                                        <i class="fas fa-lock"></i> Change Password
                                    </h6>

                                    <div class="mb-3">
                                        <label class="form-label fw-semibold">Current Password</label>
                                        <input type="password" class="form-control" placeholder="Enter current password">
                                    </div>

                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">New Password</label>
                                            <input type="password" class="form-control" placeholder="Enter new password">
                                            <small class="text-muted d-block mt-1">
                                                <i class="fas fa-info-circle"></i> Min 8 chars, uppercase, lowercase, number, special char
                                            </small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-semibold">Confirm Password</label>
                                            <input type="password" class="form-control" placeholder="Confirm new password">
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-flex gap-2 mt-4">
                                    <button class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600;">
                                        <i class="fas fa-save"></i> Save Changes
                                    </button>
                                    <button class="btn btn-secondary">
                                        <i class="fas fa-times"></i> Cancel
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Success Popup -->
    <div id="successPopup" class="success-popup-overlay">
        <div class="success-popup">
            <div class="success-popup-icon">
                <i class="fas fa-check"></i>
            </div>
            <h3>Success!</h3>
            <p id="successPopupMessage">Profile updated successfully!</p>
            <button class="success-popup-btn" onclick="EcoJourney.closeSuccessPopup()">Great!</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="frontend/static/js/common.js"></script>
    <script>
        function updateProfileInfo() {
            console.log('[Profile] Updating profile info...');
            const role = localStorage.getItem('user_role') || 'producer';
            console.log('[Profile] Role:', role);
            
            const userNames = {
                admin: { fullName: 'Tom Smith', initials: 'TS', email: 'tom.smith@ecojourney.com' },
                manager: { fullName: 'Jane Smith', initials: 'JS', email: 'jane.smith@ecojourney.com' },
                producer: { fullName: 'John Doe', initials: 'JD', email: 'john.doe@ecojourney.com' }
            };
            
            const userData = userNames[role] || userNames.producer;
            console.log('[Profile] User data:', userData);
            
            // Update profile name
            const nameEl = document.getElementById('profile-name');
            if (nameEl) {
                nameEl.textContent = userData.fullName;
                console.log('[Profile] ✓ Set name to:', userData.fullName);
            } else {
                console.error('[Profile] ❌ Name element not found');
            }
            
            // Update profile email
            const emailEl = document.getElementById('profile-email');
            if (emailEl) {
                emailEl.textContent = userData.email;
                console.log('[Profile] ✓ Set email to:', userData.email);
            } else {
                console.error('[Profile] ❌ Email element not found');
            }
            
            // Update profile picture
            const picEl = document.getElementById('profile-pic-display');
            if (picEl) {
                const avatarUrl = `https://ui-avatars.com/api/?name=${userData.fullName.replace(' ', '+')}&background=667eea&color=fff&size=120&bold=true`;
                picEl.src = avatarUrl;
                console.log('[Profile] ✓ Set profile picture');
            } else {
                console.error('[Profile] ❌ Profile pic element not found');
            }
            
            // Update stats based on role
            updateRoleStats(role);
            console.log('[Profile] ✓ Profile update complete');
        }
        
        function updateRoleStats(role) {
            const statsContainer = document.getElementById('profile-stats');
            if (!statsContainer) return;
            
            let statsHTML = '';
            
            if (role === 'admin') {
                statsHTML = `
                    <div class="stat-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <p class="mb-0 fs-3 fw-bold" id="admin-total-users">--</p>
                        <p class="mb-0 small opacity-90">Total Users</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                        <p class="mb-0 fs-3 fw-bold" id="admin-total-content">--</p>
                        <p class="mb-0 small opacity-90">Total Content</p>
                    </div>
                `;
            } else if (role === 'manager') {
                statsHTML = `
                    <div class="stat-box" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                        <p class="mb-0 fs-3 fw-bold" id="manager-total-reviewed">--</p>
                        <p class="mb-0 small opacity-90">Total Reviewed</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                        <p class="mb-0 fs-3 fw-bold" id="manager-pending">--</p>
                        <p class="mb-0 small opacity-90">Pending Review</p>
                    </div>
                `;
            } else if (role === 'producer') {
                statsHTML = `
                    <div class="stat-box" style="background: linear-gradient(135deg, #67e0d1 0%, #37e0c9 100%);">
                        <p class="mb-0 fs-3 fw-bold" id="producer-total-uploaded">--</p>
                        <p class="mb-0 small opacity-90">Content Uploaded</p>
                    </div>
                    <div class="stat-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <p class="mb-0 fs-3 fw-bold" id="producer-published">--</p>
                        <p class="mb-0 small opacity-90">Published Content</p>
                    </div>
                `;
            }
            
            statsContainer.innerHTML = statsHTML;
            
            // Load real data from API
            loadRealStats(role);
        }
        
        async function loadRealStats(role) {
            try {
                const response = await fetch(`${EcoJourney.API_URL}/api/content/all`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    console.error('[Profile] Failed to load stats data');
                    return;
                }
                
                const allContent = await response.json();
                console.log('[Profile] Loaded', allContent.length, 'content items for stats');
                
                if (role === 'admin') {
                    const totalContentEl = document.getElementById('admin-total-content');
                    if (totalContentEl) totalContentEl.textContent = allContent.length;
                    
                    const totalUsersEl = document.getElementById('admin-total-users');
                    if (totalUsersEl) totalUsersEl.textContent = '3'; // Hardcoded as user API not available
                    
                } else if (role === 'manager') {
                    const pending = allContent.filter(item => 
                        (item.status || 'Pending').toLowerCase() === 'pending'
                    ).length;
                    const reviewed = allContent.filter(item => 
                        (item.status || '').toLowerCase().includes('approved') || 
                        (item.status || '').toLowerCase().includes('rejected')
                    ).length;
                    
                    const pendingEl = document.getElementById('manager-pending');
                    if (pendingEl) pendingEl.textContent = pending;
                    
                    const reviewedEl = document.getElementById('manager-total-reviewed');
                    if (reviewedEl) reviewedEl.textContent = reviewed;
                    
                } else if (role === 'producer') {
                    const published = allContent.filter(item => 
                        (item.status || '').toLowerCase().includes('approved') || 
                        (item.status || '').toLowerCase().includes('published')
                    ).length;
                    
                    const totalUploadedEl = document.getElementById('producer-total-uploaded');
                    if (totalUploadedEl) totalUploadedEl.textContent = allContent.length;
                    
                    const publishedEl = document.getElementById('producer-published');
                    if (publishedEl) publishedEl.textContent = published;
                }
                
            } catch (error) {
                console.error('[Profile] Failed to load stats:', error);
            }
        }
        
        // Handle profile picture upload
        document.getElementById('profile-pic-input')?.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }
            
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (evt) => {
                const imageData = evt.target.result;
                document.getElementById('profile-pic-display').src = imageData;
                localStorage.setItem('profile-picture', imageData);
                EcoJourney.showSuccessPopup('Profile picture updated successfully!');
            };
            reader.readAsDataURL(file);
        });
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('[Profile] DOM loaded, initializing...');
            console.log('[Profile] Current user:', localStorage.getItem('current_user'));
            console.log('[Profile] User role:', localStorage.getItem('user_role'));
            EcoJourney.initializePage('profile');
            updateProfileInfo();
            
            // Load saved profile picture
            const savedPicture = localStorage.getItem('profile-picture');
            if (savedPicture) {
                const picEl = document.getElementById('profile-pic-display');
                if (picEl) picEl.src = savedPicture;
            }
        });
    </script>
</body>
</html>
